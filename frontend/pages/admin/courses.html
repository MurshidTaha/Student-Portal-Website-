<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Courses - Admin Panel</title>
    <link rel="stylesheet" href="../../css/style.css">
    <link rel="stylesheet" href="../../css/responsive.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .admin-header {
            background: linear-gradient(135deg, #2c3e50, #34495e);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        
        .admin-sidebar {
            background: #f8f9fa;
            padding: 2rem;
            border-radius: 10px;
            height: fit-content;
        }
        
        .admin-nav {
            list-style: none;
            padding: 0;
        }
        
        .admin-nav li {
            margin-bottom: 0.5rem;
        }
        
        .admin-nav a {
            display: block;
            padding: 0.75rem 1rem;
            color: #333;
            text-decoration: none;
            border-radius: 5px;
            transition: all 0.3s;
        }
        
        .admin-nav a:hover,
        .admin-nav a.active {
            background: #2c3e50;
            color: white;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            text-align: center;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .action-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        .search-box {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .search-box input {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            width: 300px;
        }
        
        .btn-add {
            background: #27ae60;
            color: white;
            border: none;
            padding: 0.5rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .btn-add:hover {
            background: #219955;
        }
        
        .table-container {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            overflow: hidden;
        }
        
        .courses-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .courses-table th,
        .courses-table td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .courses-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #2c3e50;
        }
        
        .courses-table tr:hover {
            background: #f8f9fa;
        }
        
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background: #f8d7da;
            color: #721c24;
        }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .btn-action {
            padding: 0.25rem 0.75rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        
        .btn-edit {
            background: #3498db;
            color: white;
        }
        
        .btn-delete {
            background: #e74c3c;
            color: white;
        }
        
        .btn-view {
            background: #2ecc71;
            color: white;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            background: white;
            border-top: 1px solid #eee;
        }
        
        .pagination button {
            padding: 0.5rem 1rem;
            border: 1px solid #ddd;
            background: white;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .pagination button.active {
            background: #2c3e50;
            color: white;
            border-color: #2c3e50;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .form-group textarea {
            min-height: 100px;
            resize: vertical;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 2rem;
        }
        
        .btn-cancel {
            background: #95a5a6;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .btn-submit {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Admin Navigation -->
    <div class="admin-header">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <h1>Admin Panel</h1>
                <div class="d-flex align-items-center gap-3">
                    <span>Welcome, Admin</span>
                    <a href="../dashboard.html" class="btn btn-light">Back to Dashboard</a>
                    <a href="#" onclick="authService.logout()" class="btn btn-outline-light">Logout</a>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="row">
            <!-- Sidebar -->
            <div class="col-lg-3">
                <div class="admin-sidebar">
                    <h3>Admin Menu</h3>
                    <ul class="admin-nav">
                        <li><a href="dashboard.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                        <li><a href="users.html"><i class="fas fa-users"></i> Users</a></li>
                        <li><a href="courses.html" class="active"><i class="fas fa-book"></i> Courses</a></li>
                        <li><a href="#"><i class="fas fa-file-alt"></i> Assignments</a></li>
                        <li><a href="#"><i class="fas fa-chart-line"></i> Grades</a></li>
                        <li><a href="#"><i class="fas fa-cog"></i> Settings</a></li>
                    </ul>
                </div>
            </div>

            <!-- Main Content -->
            <div class="col-lg-9">
                <!-- Stats Overview -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="total-courses">0</div>
                        <div class="stat-label">Total Courses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="active-courses">0</div>
                        <div class="stat-label">Active Courses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="total-enrollments">0</div>
                        <div class="stat-label">Total Enrollments</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avg-students">0</div>
                        <div class="stat-label">Avg. Students/Course</div>
                    </div>
                </div>

                <!-- Action Bar -->
                <div class="action-bar">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="search-input" placeholder="Search courses...">
                    </div>
                    <button class="btn-add" onclick="openAddCourseModal()">
                        <i class="fas fa-plus"></i> Add New Course
                    </button>
                </div>

                <!-- Courses Table -->
                <div class="table-container">
                    <table class="courses-table">
                        <thead>
                            <tr>
                                <th>Course Code</th>
                                <th>Course Name</th>
                                <th>Instructor</th>
                                <th>Department</th>
                                <th>Enrolled</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="courses-table-body">
                            <!-- Courses will be loaded here -->
                        </tbody>
                    </table>
                    
                    <!-- Pagination -->
                    <div class="pagination" id="pagination">
                        <!-- Pagination will be loaded here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Course Modal -->
    <div class="modal" id="course-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modal-title">Add New Course</h2>
                <button class="close-modal" onclick="closeModal()">&times;</button>
            </div>
            
            <form id="course-form">
                <input type="hidden" id="course-id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="course-code">Course Code *</label>
                        <input type="text" id="course-code" required>
                    </div>
                    <div class="form-group">
                        <label for="course-title">Course Title *</label>
                        <input type="text" id="course-title" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="course-description">Description *</label>
                    <textarea id="course-description" required></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="department">Department *</label>
                        <select id="department" required>
                            <option value="">Select Department</option>
                            <option value="Computer Science">Computer Science</option>
                            <option value="Software Engineering">Software Engineering</option>
                            <option value="Information Technology">Information Technology</option>
                            <option value="Electrical Engineering">Electrical Engineering</option>
                            <option value="Mechanical Engineering">Mechanical Engineering</option>
                            <option value="Business Administration">Business Administration</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="semester">Semester *</label>
                        <select id="semester" required>
                            <option value="">Select Semester</option>
                            <option value="1">Semester 1</option>
                            <option value="2">Semester 2</option>
                            <option value="3">Semester 3</option>
                            <option value="4">Semester 4</option>
                            <option value="5">Semester 5</option>
                            <option value="6">Semester 6</option>
                            <option value="7">Semester 7</option>
                            <option value="8">Semester 8</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="credits">Credits *</label>
                        <select id="credits" required>
                            <option value="">Select Credits</option>
                            <option value="1">1 Credit</option>
                            <option value="2">2 Credits</option>
                            <option value="3">3 Credits</option>
                            <option value="4">4 Credits</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="instructor">Instructor</label>
                        <select id="instructor">
                            <option value="">Select Instructor</option>
                            <!-- Instructors will be loaded dynamically -->
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="days">Schedule Days</label>
                        <input type="text" id="days" placeholder="e.g., Mon, Wed, Fri">
                    </div>
                    <div class="form-group">
                        <label for="time">Schedule Time</label>
                        <input type="text" id="time" placeholder="e.g., 10:00 AM - 11:30 AM">
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="room">Room/Location</label>
                    <input type="text" id="room" placeholder="e.g., Room 301">
                </div>
                
                <div class="form-group">
                    <label for="status">Status</label>
                    <select id="status">
                        <option value="true">Active</option>
                        <option value="false">Inactive</option>
                    </select>
                </div>
                
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn-submit">Save Course</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../../js/auth.js"></script>
    <script src="../../js/api.js"></script>
    <script src="../../js/main.js"></script>
    <script>
        let currentPage = 1;
        let totalPages = 1;
        let currentEditId = null;

        document.addEventListener('DOMContentLoaded', async function() {
            // Check if user is admin
            if (!authService.isAuthenticated() || !authService.isAdmin()) {
                window.location.href = '../../index.html';
                return;
            }

            await loadCourses();
            await loadCourseStats();
            await loadInstructors();
            setupEventListeners();
        });

        async function loadCourses(page = 1) {
            try {
                showLoading();
                const response = await apiService.request(`/courses?page=${page}&limit=10`);
                
                if (response.success) {
                    renderCourses(response.courses);
                    renderPagination(response.pagination);
                }
            } catch (error) {
                console.error('Failed to load courses:', error);
                studentPortal.showToast('Failed to load courses', 'error');
            } finally {
                hideLoading();
            }
        }

        async function loadCourseStats() {
            try {
                const response = await apiService.request('/courses/stats');
                if (response.success) {
                    document.getElementById('total-courses').textContent = response.stats.totalCourses;
                    document.getElementById('active-courses').textContent = response.stats.activeCourses;
                    document.getElementById('total-enrollments').textContent = response.stats.totalEnrollments;
                    document.getElementById('avg-students').textContent = response.stats.avgStudentsPerCourse;
                }
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        async function loadInstructors() {
            try {
                const response = await apiService.request('/users?role=teacher&limit=100');
                if (response.success) {
                    const select = document.getElementById('instructor');
                    select.innerHTML = '<option value="">Select Instructor</option>';
                    
                    response.users.forEach(user => {
                        const option = document.createElement('option');
                        option.value = user._id;
                        option.textContent = user.profile?.fullName || user.username;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Failed to load instructors:', error);
            }
        }

        function renderCourses(courses) {
            const tbody = document.getElementById('courses-table-body');
            
            if (!courses || courses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">No courses found</td></tr>';
                return;
            }

            tbody.innerHTML = courses.map(course => `
                <tr>
                    <td>${course.code}</td>
                    <td>${course.title}</td>
                    <td>${course.instructor?.profile?.fullName || course.instructor?.username || 'Not assigned'}</td>
                    <td>${course.department}</td>
                    <td>${course.enrolledStudents?.length || 0}</td>
                    <td>
                        <span class="status-badge ${course.isActive ? 'status-active' : 'status-inactive'}">
                            ${course.isActive ? 'Active' : 'Inactive'}
                        </span>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="btn-action btn-view" onclick="viewCourse('${course._id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn-action btn-edit" onclick="editCourse('${course._id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-action btn-delete" onclick="deleteCourse('${course._id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function renderPagination(pagination) {
            const container = document.getElementById('pagination');
            if (!pagination || pagination.pages <= 1) {
                container.innerHTML = '';
                return;
            }

            let html = '';
            
            // Previous button
            html += `<button ${pagination.page === 1 ? 'disabled' : ''} onclick="changePage(${pagination.page - 1})">
                <i class="fas fa-chevron-left"></i>
            </button>`;
            
            // Page numbers
            for (let i = 1; i <= pagination.pages; i++) {
                if (i === 1 || i === pagination.pages || (i >= pagination.page - 2 && i <= pagination.page + 2)) {
                    html += `<button ${i === pagination.page ? 'class="active"' : ''} onclick="changePage(${i})">${i}</button>`;
                } else if (i === pagination.page - 3 || i === pagination.page + 3) {
                    html += '<span>...</span>';
                }
            }
            
            // Next button
            html += `<button ${pagination.page === pagination.pages ? 'disabled' : ''} onclick="changePage(${pagination.page + 1})">
                <i class="fas fa-chevron-right"></i>
            </button>`;
            
            container.innerHTML = html;
        }

        function setupEventListeners() {
            // Search input
            const searchInput = document.getElementById('search-input');
            let searchTimeout;
            
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    searchCourses(this.value);
                }, 500);
            });

            // Course form submission
            document.getElementById('course-form').addEventListener('submit', async function(e) {
                e.preventDefault();
                await saveCourse();
            });
        }

        function changePage(page) {
            currentPage = page;
            loadCourses(page);
        }

        async function searchCourses(query) {
            try {
                const response = await apiService.request(`/courses?search=${encodeURIComponent(query)}`);
                if (response.success) {
                    renderCourses(response.courses);
                }
            } catch (error) {
                console.error('Search failed:', error);
            }
        }

        function openAddCourseModal() {
            currentEditId = null;
            document.getElementById('modal-title').textContent = 'Add New Course';
            document.getElementById('course-form').reset();
            document.getElementById('course-id').value = '';
            document.getElementById('course-modal').style.display = 'flex';
        }

        async function editCourse(id) {
            try {
                const response = await apiService.request(`/courses/${id}`);
                if (response.success) {
                    currentEditId = id;
                    document.getElementById('modal-title').textContent = 'Edit Course';
                    
                    const course = response.course;
                    document.getElementById('course-id').value = course._id;
                    document.getElementById('course-code').value = course.code || '';
                    document.getElementById('course-title').value = course.title || '';
                    document.getElementById('course-description').value = course.description || '';
                    document.getElementById('department').value = course.department || '';
                    document.getElementById('semester').value = course.semester || '';
                    document.getElementById('credits').value = course.credits || '';
                    document.getElementById('instructor').value = course.instructor?._id || '';
                    document.getElementById('days').value = course.schedule?.days?.join(', ') || '';
                    document.getElementById('time').value = course.schedule?.time || '';
                    document.getElementById('room').value = course.schedule?.room || '';
                    document.getElementById('status').value = course.isActive;
                    
                    document.getElementById('course-modal').style.display = 'flex';
                }
            } catch (error) {
                console.error('Failed to load course:', error);
                studentPortal.showToast('Failed to load course details', 'error');
            }
        }

        async function saveCourse() {
            try {
                const formData = {
                    code: document.getElementById('course-code').value,
                    title: document.getElementById('course-title').value,
                    description: document.getElementById('course-description').value,
                    department: document.getElementById('department').value,
                    semester: parseInt(document.getElementById('semester').value),
                    credits: parseInt(document.getElementById('credits').value),
                    instructor: document.getElementById('instructor').value || undefined,
                    schedule: {
                        days: document.getElementById('days').value.split(',').map(d => d.trim()).filter(d => d),
                        time: document.getElementById('time').value,
                        room: document.getElementById('room').value
                    },
                    isActive: document.getElementById('status').value === 'true'
                };

                // Remove empty schedule fields
                if (!formData.schedule.days.length) delete formData.schedule.days;
                if (!formData.schedule.time) delete formData.schedule.time;
                if (!formData.schedule.room) delete formData.schedule.room;
                if (Object.keys(formData.schedule).length === 0) delete formData.schedule;

                const url = currentEditId ? `/courses/${currentEditId}` : '/courses';
                const method = currentEditId ? 'PUT' : 'POST';

                const response = await apiService.request(url, {
                    method: method,
                    body: JSON.stringify(formData)
                });

                if (response.success) {
                    studentPortal.showToast(
                        currentEditId ? 'Course updated successfully' : 'Course created successfully',
                        'success'
                    );
                    closeModal();
                    await loadCourses(currentPage);
                    await loadCourseStats();
                }
            } catch (error) {
                console.error('Failed to save course:', error);
                studentPortal.showToast('Failed to save course', 'error');
            }
        }

        async function deleteCourse(id) {
            if (!confirm('Are you sure you want to delete this course? This action cannot be undone.')) {
                return;
            }

            try {
                const response = await apiService.request(`/courses/${id}`, {
                    method: 'DELETE'
                });

                if (response.success) {
                    studentPortal.showToast('Course deleted successfully', 'success');
                    await loadCourses(currentPage);
                    await loadCourseStats();
                }
            } catch (error) {
                console.error('Failed to delete course:', error);
                studentPortal.showToast('Failed to delete course', 'error');
            }
        }

        function viewCourse(id) {
            window.location.href = `course-detail.html?id=${id}`;
        }

        function closeModal() {
            document.getElementById('course-modal').style.display = 'none';
        }

        function showLoading() {
            const tbody = document.getElementById('courses-table-body');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';
        }

        function hideLoading() {
            // Loading state is cleared when courses are rendered
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            const modal = document.getElementById('course-modal');
            if (event.target === modal) {
                closeModal();
            }
        });
    </script>
</body>
</html>